//! Impl module for windmill_client types
//!
//! This module contains behavior for generated types.
//! The types are imported from familiar-contracts.

use familiar_contracts::prelude::*;
use serde::{Serialize, Deserialize};
use std::sync::Arc;

// Impl blocks for WindmillClient

// Methods: from_env, new, analyze_entity, generate_migration, run_flow
impl WindmillClient { # [doc = " Create a new Windmill client"] # [doc = ""] # [doc = " Reads config from config.toml with env var overrides:"] # [doc = " - WINDMILL_URL (default: http://localhost:8000)"] # [doc = " - WINDMILL_WORKSPACE (default: familiar)"] # [doc = " - WINDMILL_TOKEN (required)"] pub fn from_env () -> Option < Self > { let config = crate :: runtime_config :: CoreRuntimeConfig :: load () . ok () ; let token = config . as_ref () . map (| c | c . windmill . token . clone ()) . or_else (| | std :: env :: var ("WINDMILL_TOKEN") . ok ()) ? ; let base_url = config . as_ref () . map (| c | c . windmill . url . clone ()) . or_else (| | std :: env :: var ("WINDMILL_URL") . ok ()) . unwrap_or_else (| | "http://localhost:8000" . to_string ()) ; let workspace = config . as_ref () . map (| c | c . windmill . workspace . clone ()) . or_else (| | std :: env :: var ("WINDMILL_WORKSPACE") . ok ()) . unwrap_or_else (| | "familiar" . to_string ()) ; Some (Self { client : Client :: builder () . timeout (Duration :: from_secs (60)) . build () . ok () ? , base_url , workspace , token , }) } # [doc = " Create with explicit config"] pub fn new (base_url : & str , workspace : & str , token : & str) -> Self { Self { client : Client :: builder () . timeout (Duration :: from_secs (60)) . build () . expect ("Failed to create HTTP client") , base_url : base_url . to_string () , workspace : workspace . to_string () , token : token . to_string () , } } # [doc = " Analyze whether a struct should use EntityMeta"] pub async fn analyze_entity (& self , name : & str , code : & str , file_path : & PathBuf) -> AnalysisResponse { let request = AnalysisRequest { analysis_type : AnalysisType :: EntityClassification , code : code . to_string () , name : name . to_string () , file_path : file_path . display () . to_string () , context : Some (FAMILIAR_CONVENTIONS . to_string ()) , } ; self . run_flow ("f/familiar/analyzer/schema" , & request) . await } # [doc = " Generate migration code for a struct"] pub async fn generate_migration (& self , name : & str , code : & str , target_pattern : & str) -> AnalysisResponse { let request = AnalysisRequest { analysis_type : AnalysisType :: GenerateMigration , code : code . to_string () , name : name . to_string () , file_path : String :: new () , context : Some (format ! ("Target pattern: {}\n\n{}" , target_pattern , FAMILIAR_CONVENTIONS)) , } ; self . run_flow ("f/familiar/analyzer/schema" , & request) . await } # [doc = " Run a Windmill flow and return the result"] async fn run_flow (& self , flow_path : & str , request : & AnalysisRequest) -> AnalysisResponse { let url = format ! ("{}/api/w/{}/jobs/run_wait_result/f/{}" , self . base_url , self . workspace , flow_path) ; match self . client . post (& url) . bearer_auth (& self . token) . json (request) . send () . await { Ok (response) => { if response . status () . is_success () { response . json () . await . unwrap_or_else (| e | AnalysisResponse { error : Some (format ! ("Failed to parse response: {}" , e)) , .. Default :: default () }) } else { let status = response . status () ; let body = response . text () . await . unwrap_or_default () ; AnalysisResponse { error : Some (format ! ("Windmill error {}: {}" , status , body)) , .. Default :: default () } } } Err (e) => AnalysisResponse { error : Some (format ! ("Request failed: {}" , e)) , .. Default :: default () } , } } }

